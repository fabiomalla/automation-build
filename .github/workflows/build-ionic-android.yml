run-name: Build Ionic Android - ${{ github.event.inputs.client_name || 'all' }}

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: "Nome del cliente da buildare (es: napoli, sibook-tattoo)"
        required: true
        type: string
      branch:
        description: "Branch del repository privato da buildare"
        required: false
        default: "main"
        type: string
      build_only:
        description: "Solo build senza upload (default: false)"
        required: false
        default: false
        type: boolean
      deploy_vps:
        description: "Deploy su VPS dopo build (default: true)"
        required: false
        default: true
        type: boolean
  repository_dispatch:
    types: [build-ionic-android]

env:
  NODE_VERSION: '22.21.1'
  JAVA_VERSION: '21'

jobs:
  build_android:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout the Private Repository
        uses: actions/checkout@v3
        with:
          repository: lorenzomalla/sibook-app-ionic
          token: ${{ secrets.EASYBOOK_RELEASE_AUTOMATION_REPO_TOKEN }}
          ref: ${{ github.event.inputs.branch || github.event.client_payload.branch || 'main' }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install dependencies
        run: |
          # Rimuovi package-lock.json e node_modules per evitare bug npm con dipendenze opzionali
          rm -rf node_modules package-lock.json
          npm install

      - name: Determine client name
        id: client
        run: |
          if [ -n "${{ github.event.inputs.client_name }}" ]; then
            CLIENT_NAME="${{ github.event.inputs.client_name }}"
          elif [ -n "${{ github.event.client_payload.client_name }}" ]; then
            CLIENT_NAME="${{ github.event.client_payload.client_name }}"
          else
            CLIENT_NAME="all"
          fi
          echo "client_name=$CLIENT_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ” Client da buildare: $CLIENT_NAME"

      - name: Get clients list
        id: clients
        run: |
          if [ "${{ steps.client.outputs.client_name }}" == "all" ]; then
            CLIENTS=$(node -e "const fs = require('fs'); const config = JSON.parse(fs.readFileSync('./clients.config.json', 'utf8')); console.log(Object.keys(config.clients).join(','))")
            echo "clients=$CLIENTS" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Clienti trovati: $CLIENTS"
          else
            echo "clients=${{ steps.client.outputs.client_name }}" >> $GITHUB_OUTPUT
          fi

      # Flag: se esiste sibook.txt => build per account SiBook
      - name: Detect SiBook release flag
        run: |
          if [ -f "sibook.txt" ]; then
            echo "SIBOOK_RELEASE=true" >> $GITHUB_ENV
          else
            echo "SIBOOK_RELEASE=false" >> $GITHUB_ENV
          fi

      # Sceglie le credenziali Play Store in base a SIBOOK_RELEASE
      - name: Set environment variables for Android
        run: |
          if [ "$SIBOOK_RELEASE" = "true" ]; then
            # Controllo di sicurezza: se manca il secret fallisce subito
            if [ -z "${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64_SIBOOK }}" ]; then
              echo "âŒ Missing GOOGLE_PLAY_JSON_KEY_BASE64_SIBOOK while SIBOOK_RELEASE=true"
              exit 1
            fi

            echo "Using SiBook Google Play account"
            echo "GOOGLE_PLAY_EMAIL=${{ secrets.GOOGLE_PLAY_EMAIL_SIBOOK }}" >> $GITHUB_ENV
            echo "GOOGLE_PLAY_PASSWORD=${{ secrets.GOOGLE_PLAY_PASSWORD_SIBOOK }}" >> $GITHUB_ENV
            echo "GOOGLE_PLAY_JSON_KEY_BASE64=${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64_SIBOOK }}" >> $GITHUB_ENV
          else
            if [ -z "${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64 }}" ]; then
              echo "âŒ Missing GOOGLE_PLAY_JSON_KEY_BASE64"
              exit 1
            fi

            echo "Using Lorenzo Google Play account"
            echo "GOOGLE_PLAY_EMAIL=${{ secrets.GOOGLE_PLAY_EMAIL }}" >> $GITHUB_ENV
            echo "GOOGLE_PLAY_PASSWORD=${{ secrets.GOOGLE_PLAY_PASSWORD }}" >> $GITHUB_ENV
            echo "GOOGLE_PLAY_JSON_KEY_BASE64=${{ secrets.GOOGLE_PLAY_JSON_KEY_BASE64 }}" >> $GITHUB_ENV
          fi

      - name: Setup Android keystore from credentials.json
        id: keystore_setup
        run: |
          KEYSTORE_CONFIGURED=false
          
          # Leggi credentials.json se esiste (opzionale, come in app-refactor)
          if [ -f "credentials.json" ]; then
            echo "ðŸ“¦ Usando credentials.json per keystore"
            KEYSTORE_PATH=$(node -e "const creds = require('./credentials.json'); console.log(creds.android?.keystore?.keystorePath || '')")
            KEYSTORE_PASSWORD=$(node -e "const creds = require('./credentials.json'); console.log(creds.android?.keystore?.keystorePassword || '')")
            KEY_ALIAS=$(node -e "const creds = require('./credentials.json'); console.log(creds.android?.keystore?.keyAlias || '')")
            KEY_PASSWORD=$(node -e "const creds = require('./credentials.json'); console.log(creds.android?.keystore?.keyPassword || '')")
            
            if [ -n "$KEYSTORE_PATH" ] && [ -n "$KEYSTORE_PASSWORD" ]; then
              # Crea directory keystore se necessario
              mkdir -p $(dirname "$KEYSTORE_PATH")
              echo "KEYSTORE_PATH=$KEYSTORE_PATH" >> $GITHUB_ENV
              echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
              echo "KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
              echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
              KEYSTORE_CONFIGURED=true
              echo "âœ… Keystore configurato da credentials.json"
            else
              echo "âš ï¸  credentials.json presente ma dati keystore incompleti"
            fi
          else
            echo "âš ï¸  credentials.json non trovato"
          fi
          
          # Se credentials.json non ha funzionato, prova GitHub Secrets
          if [ "$KEYSTORE_CONFIGURED" != "true" ]; then
            echo "ðŸ“¦ Tentativo con GitHub Secrets..."
            mkdir -p fastlane/keystores
            if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
              echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > fastlane/keystores/release.keystore
              # Usa path assoluto per evitare problemi con project_dir in Gradle
              KEYSTORE_ABS_PATH=$(pwd)/fastlane/keystores/release.keystore
              echo "KEYSTORE_PATH=$KEYSTORE_ABS_PATH" >> $GITHUB_ENV
              echo "KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
              echo "KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}" >> $GITHUB_ENV
              echo "KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}" >> $GITHUB_ENV
              KEYSTORE_CONFIGURED=true
              echo "âœ… Keystore configurato da GitHub Secrets"
              echo "ðŸ“ Path keystore: $KEYSTORE_ABS_PATH"
            else
              echo "âš ï¸  GitHub Secrets non configurati"
            fi
          fi
          
          # Se ancora non configurato, verifica se Ã¨ build_only
          if [ "$KEYSTORE_CONFIGURED" != "true" ]; then
            BUILD_ONLY="${{ github.event.inputs.build_only || github.event.client_payload.build_only || 'false' }}"
            if [ "$BUILD_ONLY" == "true" ]; then
              echo "âš ï¸  Keystore non configurato ma build_only=true - continuo senza keystore (build non firmato)"
              echo "KEYSTORE_PATH=" >> $GITHUB_ENV
              echo "KEYSTORE_PASSWORD=" >> $GITHUB_ENV
              echo "KEY_ALIAS=" >> $GITHUB_ENV
              echo "KEY_PASSWORD=" >> $GITHUB_ENV
            else
              echo "âŒ Nessuna configurazione keystore trovata e build_only=false!"
              echo "âŒ Per rilasciare su Play Store serve un keystore."
              echo "âŒ Configura:"
              echo "   1. credentials.json nel repository privato, oppure"
              echo "   2. Secret ANDROID_KEYSTORE_BASE64 nel repository pubblico"
              exit 1
            fi
          fi
          
          echo "keystore_configured=$KEYSTORE_CONFIGURED" >> $GITHUB_OUTPUT

      - name: Create .env.android
        run: |
          # Crea .env.android solo se keystore Ã¨ configurato
          if [ -n "${KEYSTORE_PATH}" ]; then
            cat > .env.android << EOF
          KEYSTORE_PATH=${KEYSTORE_PATH}
          KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
          KEY_ALIAS=${KEY_ALIAS}
          KEY_PASSWORD=${KEY_PASSWORD}
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON=./fastlane/google-play-service-account.json
          EOF
            echo "âœ… .env.android creato con keystore"
          else
            cat > .env.android << EOF
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON=./fastlane/google-play-service-account.json
          EOF
            echo "âš ï¸  .env.android creato senza keystore (build non firmato)"
          fi

      - name: Decode and Create Google Play Json Key
        run: |
          echo "${{ env.GOOGLE_PLAY_JSON_KEY_BASE64 }}" | base64 --decode > google_play_json_key.json

      - name: Install Fastlane
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby-full
          echo 'export GEM_HOME=$HOME/.gem' >> $GITHUB_ENV
          echo 'export PATH=$HOME/.gem/bin:$PATH' >> $GITHUB_ENV
          gem install --user-install fastlane -NV

      - name: Build for each client
        env:
          CLIENT_NAME: ${{ steps.client.outputs.client_name }}
          BUILD_ONLY: ${{ github.event.inputs.build_only || github.event.client_payload.build_only || 'false' }}
          DEPLOY_VPS: ${{ github.event.inputs.deploy_vps || github.event.client_payload.deploy_vps || 'true' }}
        run: |
          IFS=',' read -ra CLIENTS_ARRAY <<< "${{ steps.clients.outputs.clients }}"
          for CLIENT in "${CLIENTS_ARRAY[@]}"; do
            echo "ðŸš€ Building Android per: $CLIENT"
            
            # Configura per il cliente (necessario per estrarre la versione)
            node scripts/build-client.js $CLIENT --production
            
            # Estrai versione da android/app/build.gradle dopo la configurazione
            APP_VERSION=$(grep -E "versionName\s+" android/app/build.gradle | sed -E 's/.*versionName\s+"([^"]+)".*/\1/' || echo "1.0.0")
            ANDROID_PACKAGE=$(grep -E "applicationId\s+" android/app/build.gradle | sed -E 's/.*applicationId\s+"([^"]+)".*/\1/' || echo "")
            APP_NAME=$(node -e "const fs = require('fs'); const config = JSON.parse(fs.readFileSync('./clients.config.json', 'utf8')); console.log(config.clients['$CLIENT']?.appName || '')")
            
            echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
            echo "ANDROID_PACKAGE=$ANDROID_PACKAGE" >> $GITHUB_ENV
            echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
            echo "ðŸ“¦ Versione app: $APP_VERSION"
            echo "ðŸ“± Package: $ANDROID_PACKAGE"
            
            if [ "$BUILD_ONLY" == "true" ]; then
              fastlane android build client:$CLIENT
            else
              fastlane android release client:$CLIENT deploy_vps:$DEPLOY_VPS
            fi
            
            # Se Ã¨ la prima release (1.0.0), chiama il repository di automazione
            if [ "$APP_VERSION" == "1.0.0" ] && [ "$BUILD_ONLY" != "true" ]; then
              echo "ðŸ†• Prima release (1.0.0) - chiamando repository di automazione"
              
              # Checkout Easybook Automation Repository usando git clone con token
              git clone https://${{ secrets.EASYBOOK_RELEASE_AUTOMATION_REPO_TOKEN }}@github.com/lorenzomalla/easybook-release-automation-android.git easybook-release-automation-android || true
              cd easybook-release-automation-android
              npm ci
              
              # Se SIBOOK_RELEASE = true, usa lo script dedicato
              if [ "$SIBOOK_RELEASE" == "true" ]; then
                GOOGLE_PLAY_EMAIL="${{ env.GOOGLE_PLAY_EMAIL }}" GOOGLE_PLAY_PASSWORD="${{ env.GOOGLE_PLAY_PASSWORD }}" npm run release:sibook
              else
                GOOGLE_PLAY_EMAIL="${{ env.GOOGLE_PLAY_EMAIL }}" GOOGLE_PLAY_PASSWORD="${{ env.GOOGLE_PLAY_PASSWORD }}" npm run start
              fi
              
              cd ..
            elif [ "$APP_VERSION" != "1.0.0" ] && [ "$BUILD_ONLY" != "true" ]; then
              echo "ðŸ”„ Aggiornamento ($APP_VERSION) - upload tramite Fastlane"
              # L'upload Ã¨ giÃ  gestito da fastlane android release
            fi
            
            echo "âœ… Build completata per: $CLIENT"
          done

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            build/android/**
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## âœ… Build Android Completata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Client buildati:** ${{ steps.clients.outputs.clients }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build only:** ${{ github.event.inputs.build_only || github.event.client_payload.build_only || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Gli artifact sono disponibili nella sezione Artifacts di questo workflow." >> $GITHUB_STEP_SUMMARY

